server {
    listen 80;
    server_name localhost;

    error_log  /var/www/html/logs/nginx_error.log;
    access_log /var/www/html/logs/nginx_access.log;

    root /var/www/html;
    index index.php index.html index.htm;

    # Allow uploads up to 25MB (larger than the 20MB PHP validation)
    client_max_body_size 25M;

    # =====================================================
    # Performance: Gzip Compression
    # =====================================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_types
        text/plain
        text/css
        text/javascript
        text/xml
        application/json
        application/javascript
        application/x-javascript
        application/xml
        application/xml+rss
        application/vnd.ms-fontobject
        font/eot
        font/opentype
        font/otf
        font/ttf
        image/svg+xml;

    # =====================================================
    # Performance: Connection & Buffer Tuning
    # =====================================================
    keepalive_timeout 65;
    keepalive_requests 100;

    # Optimize sendfile for static content
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # =====================================================
    # Static Assets: Long-term caching with versioning
    # =====================================================
    location ~* \.(js|css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
        access_log off;
    }

    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Content-Type-Options "nosniff";
        access_log off;
    }

    # =====================================================
    # Cache Purge Endpoint (internal only, requires secret)
    # =====================================================
    location = /api/cache-purge {
        # Only allow local requests or those with correct header
        internal;
        # This is handled by PHP to purge cache
    }

    # =====================================================
    # API Endpoints: Never cache (dynamic data)
    # =====================================================
    location ^~ /api/ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param PHP_VALUE "log_errors=On\nerror_log=/var/www/html/logs/php_errors.log\ndisplay_errors=Off";

        # Explicitly disable caching for all API endpoints
        fastcgi_cache off;
        add_header X-Cache-Status "BYPASS-API" always;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
    }

    # =====================================================
    # PHP with FastCGI Caching
    # =====================================================
    location ~ \.php$ {
        try_files $uri =404;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        fastcgi_param PHP_VALUE "log_errors=On\nerror_log=/var/www/html/logs/php_errors.log\ndisplay_errors=Off";

        # =====================================================
        # FastCGI Cache Configuration
        # =====================================================
        fastcgi_cache POSTCACHE;
        fastcgi_cache_valid 200 5m;           # Cache successful responses for 5 minutes
        fastcgi_cache_valid 301 302 1m;       # Cache redirects for 1 minute
        fastcgi_cache_valid any 0;            # Don't cache errors
        fastcgi_cache_methods GET HEAD;       # Only cache GET/HEAD requests
        fastcgi_cache_use_stale error timeout updating invalid_header;
        fastcgi_cache_lock on;                # Prevent cache stampede
        fastcgi_cache_lock_timeout 5s;

        # =====================================================
        # Cache Bypass Rules (dynamic content)
        # =====================================================
        # Bypass cache for:
        # - POST/PUT/DELETE requests (handled by fastcgi_cache_methods)
        # - Authenticated users (have PHPSESSID cookie)
        # - Admin pages (?page=admin)
        # - Login pages (?page=login)
        # - Requests with cache-control: no-cache header

        set $no_cache 0;

        # Bypass for authenticated users (session cookie present)
        if ($http_cookie ~* "PHPSESSID") {
            set $no_cache 1;
        }

        # Bypass for admin page
        if ($arg_page = "admin") {
            set $no_cache 1;
        }

        # Bypass for login page
        if ($arg_page = "login") {
            set $no_cache 1;
        }

        # Bypass if client requests no-cache
        if ($http_cache_control ~* "no-cache") {
            set $no_cache 1;
        }

        # Apply bypass rules
        fastcgi_cache_bypass $no_cache;
        fastcgi_no_cache $no_cache;

        # Add cache status header for debugging
        add_header X-Cache-Status $upstream_cache_status always;

        # Pass cache purge header to PHP for cache busting
        fastcgi_param HTTP_X_CACHE_PURGE $http_x_cache_purge;
    }

    # =====================================================
    # Default location
    # =====================================================
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
}
