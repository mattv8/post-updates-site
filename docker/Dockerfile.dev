# Post Update - Development Container
# Standalone build for live-reload development (app source is bind-mounted)
FROM ubuntu:22.04

# Prevent interactive prompts during build
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    # Nginx web server
    nginx \
    # PHP 8.1 and extensions
    php8.1-fpm \
    php8.1-mysql \
    php8.1-gd \
    php8.1-mbstring \
    php8.1-xml \
    php8.1-curl \
    php8.1-zip \
    php8.1-bcmath \
    # MariaDB server
    mariadb-server \
    mariadb-client \
    # Image optimization tools
    webp \
    jpegoptim \
    pngquant \
    optipng \
    gifsicle \
    # Utilities
    supervisor \
    curl \
    wget \
    unzip \
    git \
    ca-certificates \
    dos2unix \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Configure PHP-FPM to pass environment variables
RUN echo "" >> /etc/php/8.1/fpm/pool.d/www.conf \
    && echo "; Pass environment variables to PHP" >> /etc/php/8.1/fpm/pool.d/www.conf \
    && echo "clear_env = no" >> /etc/php/8.1/fpm/pool.d/www.conf

# Configure PHP-FPM to not daemonize
RUN sed -i 's/;daemonize = yes/daemonize = no/g' /etc/php/8.1/fpm/php-fpm.conf

# Configure nginx
RUN echo "daemon off;" >> /etc/nginx/nginx.conf

# Create nginx cache directory for FastCGI caching
RUN mkdir -p /var/cache/nginx/fastcgi \
    && chown -R www-data:www-data /var/cache/nginx \
    && chmod -R 755 /var/cache/nginx

# Create application directory structure
RUN mkdir -p /var/www/html \
    && mkdir -p /var/www/html/storage/uploads/originals \
    && mkdir -p /var/www/html/storage/uploads/variants/16 \
    && mkdir -p /var/www/html/storage/uploads/variants/32 \
    && mkdir -p /var/www/html/storage/uploads/variants/48 \
    && mkdir -p /var/www/html/storage/uploads/variants/192 \
    && mkdir -p /var/www/html/storage/uploads/variants/200 \
    && mkdir -p /var/www/html/storage/uploads/variants/400 \
    && mkdir -p /var/www/html/storage/uploads/variants/512 \
    && mkdir -p /var/www/html/storage/uploads/variants/800 \
    && mkdir -p /var/www/html/storage/uploads/variants/1600 \
    && mkdir -p /var/www/html/storage/uploads/variants/thumbnail \
    && mkdir -p /var/www/log \
    && touch /var/www/html/index.php \
    && chown -R www-data:www-data /var/www/html \
    && chmod -R 775 /var/www/html/storage

# Copy nginx configuration
COPY docker/nginx/default.conf /etc/nginx/sites-available/default
COPY docker/nginx/fastcgi-cache.conf /etc/nginx/conf.d/fastcgi-cache.conf

# Copy database migrations
COPY migrations/ /docker-migrations/

# Copy initialization and migration scripts
COPY docker/scripts/init-database.sh /docker-scripts/init-database.sh
COPY docker/scripts/run-migrations.sh /docker-scripts/run-migrations.sh
COPY docker/scripts/import-database.sh /docker-scripts/import-database.sh
COPY docker/scripts/demo-reset.sh /docker-scripts/demo-reset.sh
COPY docker/scripts/cache-purge.sh /docker-scripts/cache-purge.sh
RUN dos2unix /docker-scripts/*.sh && chmod +x /docker-scripts/*.sh

# Create convenience command wrappers
RUN ln -sf /docker-scripts/import-database.sh /usr/local/bin/import \
    && ln -sf /docker-scripts/run-migrations.sh /usr/local/bin/migrate \
    && ln -sf /docker-scripts/cache-purge.sh /usr/local/bin/cache-purge

COPY <<EOF /usr/local/bin/export
#!/bin/bash
mysqldump -u"\$MYSQL_USER" -p"\$MYSQL_PASSWORD" "\$MYSQL_DATABASE" "\$@"
EOF

COPY <<EOF /usr/local/bin/drop
#!/bin/bash
/docker-scripts/import-database.sh --drop "\$@"
EOF

COPY <<EOF /usr/local/bin/seed
#!/bin/bash
php /var/www/html/lib/demo_seed.php "\$@"
EOF

RUN chmod +x /usr/local/bin/export /usr/local/bin/drop /usr/local/bin/seed

# Configure supervisord
COPY docker/scripts/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# Expose ports
EXPOSE 80 3306

# Set up entrypoint
COPY docker/scripts/entrypoint.sh /entrypoint.sh
RUN dos2unix /entrypoint.sh && chmod +x /entrypoint.sh

# Volume for database persistence
VOLUME ["/var/lib/mysql"]

ENTRYPOINT ["/entrypoint.sh"]
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
