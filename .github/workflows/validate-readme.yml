name: Validate and Update README

on:
  pull_request:
    paths:
      - 'README.md'
      - '.env.example'
      - 'docker-compose.yml'
  push:
    branches:
      - main
    paths:
      - 'README.md'
      - '.env.example'
      - 'docker-compose.yml'
  workflow_dispatch:

jobs:
  validate-readme:
    name: Validate README Sync
    runs-on: self-hosted
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update README with source files
        run: |
          python3 << 'EOF'
          import re
          import sys

          def update_section(readme_content, start_marker, source_file, indent="   "):
              """Update a collapsible section in README with content from source file"""
              try:
                  with open(source_file, 'r') as f:
                      new_content = f.read()
              except Exception as e:
                  print(f"❌ Failed to read {source_file}: {e}")
                  sys.exit(1)

              # Indent each line of the new content
              indented_content = '\n'.join(indent + line if line.strip() else ''
                                           for line in new_content.split('\n'))

              # Pattern to find the code block within the collapsible section
              # Matches from start_marker to the closing ```
              pattern = (
                  f"({re.escape(start_marker)}\\n\\n   ```[a-z]*\\n)"
                  f"(.*?)"
                  f"(\\n   ```)"
              )

              replacement = f"\\g<1>\n{indented_content}\\g<3>"

              new_readme = re.sub(pattern, replacement, readme_content, flags=re.DOTALL, count=1)

              if new_readme == readme_content:
                  print(f"❌ Failed to find or update section with marker: {start_marker}")
                  print("   Make sure the README has the expected format.")
                  sys.exit(1)

              return new_readme

          # Read README
          try:
              with open('README.md', 'r') as f:
                  readme = f.read()
          except Exception as e:
              print(f"❌ Failed to read README.md: {e}")
              sys.exit(1)

          original_readme = readme

          # Update .env.example section
          print("Updating .env template in README...")
          readme = update_section(
              readme,
              "   <summary>Click to expand .env template</summary>",
              ".env.example"
          )
          print("✓ .env template section updated")

          # Update docker-compose.yml section
          print("Updating docker-compose.yml in README...")
          readme = update_section(
              readme,
              "   <summary>Click to expand docker-compose.yml</summary>",
              "docker-compose.yml"
          )
          print("✓ docker-compose.yml section updated")

          # Write updated README
          if readme != original_readme:
              try:
                  with open('README.md', 'w') as f:
                      f.write(readme)
                  print("✓ README.md updated successfully")
              except Exception as e:
                  print(f"❌ Failed to write README.md: {e}")
                  sys.exit(1)
          else:
              print("✓ README.md already in sync")
          EOF

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "✓ README is in sync with source files"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "⚠ README is out of sync with source files"
          fi

      - name: Commit and push changes (main branch only)
        if: steps.check.outputs.changed == 'true' && github.ref == 'refs/heads/main'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git commit -m "docs: auto-update README with latest .env and docker-compose.yml"
          git push

      - name: Fail if out of sync (PR only)
        if: steps.check.outputs.changed == 'true' && github.event_name == 'pull_request'
        run: |
          echo "❌ README is out of sync with source files!"
          echo "The .env template or docker-compose.yml content in README.md doesn't match the actual files."
          echo ""
          echo "Please run the following locally to update:"
          echo "  git checkout main"
          echo "  git pull"
          echo "Then commit and push the changes."
          exit 1

      - name: Success summary
        if: steps.check.outputs.changed == 'false'
        run: |
          echo "## ✅ README Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All content in README.md is in sync with source files:" >> $GITHUB_STEP_SUMMARY
          echo "- .env.example" >> $GITHUB_STEP_SUMMARY
          echo "- docker-compose.yml" >> $GITHUB_STEP_SUMMARY
